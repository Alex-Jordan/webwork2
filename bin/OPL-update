#!/usr/bin/env perl

# This is the script formerly known as loadDB2, and then known as NPL-update.

# It is used to update
# the database when it comes to the WeBWorK Open Problem Library (OPL).
# This should be run after doing a git clone or pull for the OPL
# files.

# In order for this script to work:
#   1) The OPL downloaded to your machine (the .pg files)
#   2) The environment variable WEBWORK_ROOT needs to be
#      correctly defined (as with other scripts here).
#   3) Configuration for the OPL in site.conf needs to be
#      done (basically just setting the path to the OPL files).

use strict;
use warnings;

BEGIN {
        die "WEBWORK_ROOT not found in environment.\n"
                unless exists $ENV{WEBWORK_ROOT};
	# Unused variable, but define it to avoid an error message.
	$WeBWorK::Constants::WEBWORK_DIRECTORY = '';
	die "WEBWORK_ROOT not found in environment.\n" unless exists $ENV{WEBWORK_ROOT};
	$ENV{PG_ROOT} //= "$ENV{WEBWORK_ROOT}/../pg";
	die "The pg directory must be defined in PG_ROOT" unless (-e $ENV{PG_ROOT});
}

# Get database connection
use lib "$ENV{WEBWORK_ROOT}/lib";
use lib "$ENV{PG_ROOT}/lib";
use lib "$ENV{WEBWORK_ROOT}/bin";
use WeBWorK::CourseEnvironment;

my $ce = new WeBWorK::CourseEnvironment({webwork_dir=>$ENV{WEBWORK_ROOT}});

print "\nDownloading the latest OPL release.\n";
do $ENV{WEBWORK_ROOT} . '/bin/download-OPL-metadata-release.pl';

# Generate set definition list files.
do $ENV{WEBWORK_ROOT} . '/bin/generate-OPL-set-def-lists.pl';

if ($ce->{problemLibrary}{showLibraryLocalStats} ||
    $ce->{problemLibrary}{showLibraryGlobalStats}) {
  print "\nUpdating Library Statistics.\n";
  do $ENV{WEBWORK_ROOT}.'/bin/update-OPL-statistics.pl';

  print "\nLoading global statistics (if possible).\n";
  do $ENV{WEBWORK_ROOT}.'/bin/load-OPL-global-statistics.pl';

  print "\nSharing aggregated statistics\n";
  do $ENV{WEBWORK_ROOT}.'/bin/upload-OPL-statistics.pl';
}

print "\nDone.\n";
